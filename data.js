// var redis = require("redis"),
//     client = redis.createClient();

var redis = require('redis');
var url = require('url');


// var redisURL = url.parse(process.env.REDISCLOUD_URL);
// var client = redis.createClient(redisURL.port, redisURL.hostname, {no_ready_check: true});
// client.auth(redisURL.auth.split(":")[1]);

redisConnect();
var client;
function redisConnect() {

    if (typeof(process.env.REDISCLOUD_URL) != 'undefined') {

        var redisURL = url.parse(process.env.REDISCLOUD_URL);
        client = redis.createClient(redisURL.port, redisURL.hostname, {
            no_ready_check: true
        });

        client.auth(redisURL.auth.split(":")[1]);
        client.on("error", function(err) {
            console.log("Error " + err);
        });

    } else {
        client = redis.createClient();
        client.on("error", function(err) {
            console.log("Error " + err);
        });
    }
}



function wait60sec() {
    setTimeout(function() {
        makeRequest(wait60sec);
    }, 60000);
}

makeRequest(wait60sec);

function makeRequest(callback) {

    var request = require('request');
    request('http://waterservices.usgs.gov/nwis/iv/?format=json&sites=05200010,05200020,05200170,05200400,05200430,05200445,05200510,05200940,05200945,05201500,05201550,05201560,05207600,05209950,05210000,05210050,05210150,05210700,05211000,05211020,05211030,05213500,05213600,05217600,05217650,05218000,05220500,05220600,05221060,05227500,05227510,05227530,05240000,05242300,05242320,05261000,05263400,05263500,05267000,05268300,05269000,05270000,05270010,05270600,05270700,05272500,05273510,05273620,05273650,05273655,05275500,05275650,05283200,05283210,05283400,05283500,05288428,05288430,05288500,05288550,05288640,05288641,05288650,05288670,05288730,05288910,05288920,05288950,05289900,05330990,05331000,05331005,05331400,05331540,05331545,05331550,05331556,05331560,05331562,05331564,05331570,05331578,05331580,0533158010,05344500,05344800,05344980,05355250,05355251,05355260,05355332,05355340,05355341,05371500,05372500,05372510,05375700,05375850,05378000,05378490,05378500,05380500,05380515,05380600,05383500,05386400,05389500,05389501,05411500,05414700,05414730,05414750,05416100,05420150,05420400,05420500,05422250,05422400,05422620,05448090,05448095,05467050,05469720,05474500,05492200,05495150,05496930,05501600,05513675,05587450,05587455,05587498,05587500,05587550,05587750,07001000,07005500,07010000,07010200,07010220,07019370,07020125,07020150,07020500,07020850,07022000,07022300,07023200,07024070,07024180,07024181,07029150,07031820,07032000,07032010,07032280,07047970,07078400,07265455,07289000,07290880,07294800,07295100,07373290,07373291,07373293,07373310,07373420,07373421,07373423,07374000,07374010,07374050,07374120,07374200,07374220,07374370,07374400,07374500,07374508,07374510,07374522,07374525,07374530,07374535,07374540,07374550,073802344,285237089260300,285803089230200,285845089222500,285900089073000,285913089075630,290053089095700,290134089200601,290148089105930,290210089200600,290210089200601,290345089182500,290430089125500,290530089133930,290720089155200,290904089151700,291155089162800,291214089160300,291214089160301,291230089014000,292040089293000,292107089261100,292115089304000,292136089155300,292136089155301,292145089315000,292147089314800,292147089314801,292332089353400,292332089353401,292350089355500,292352089355400,292629089360400,292630089360400,292630089360401,292725089373000,292920089414500,293010089422500,293100089430000,293205089450500,293400089471500,293420089474500,293437089480600,293500089485000,293530089493700,293530089493701,293608089504300,293645089531500,293740089550000,293805089553700,293815089560000,293845089571000,293849089571400,293849089571401,293905089572600,294023089573900,294122089581000,294122089581001,294131089581600,294230089585700,294500090010000,294500090010001,294550090012400,294808090002400,295106089584800,295156089551400,295456090081000,295516090081900,295516090081901,295520089554000,295528089573200,295528090034800,295600089592500,295611090032500,295612090033700,295622089595800,295622089595801,295629090213000,295702090094300,295741090173600,295851090490900,295907090241000,295918090480700,300008090255800,300050090454900,300208090411700,300229090360700,300249090284800,300249090284801,300249090322700,300305090342600,300418090230200,300649090542400,301040091003300,301104091065900,301143091065900,301200091061500,301243091040400,301243091040401,301243091040402,301400091074700,301645091091700,301745091134400,301745091134401,301900091112500,302046091141200,302046091141201,302220091140800,302240091140000,302540091121000,302800091114800,303106091122000,303106091122001,303201091123300,305507091333000,305930091394800,310500091350000,310552091361200,314625091212600,315218091150000,315847091072700,315956091050000,320704091015900,320725091031000,321651090575800,322023090544500,322052090585900,323501091065500,324050091054100,325151091055200,330005091095500,333715091143301,333758091120801,333829091104201,333855091110801,340712090563700,351002090034301,353302089540002,354359089541903,362146089301901,362216089303901,363439089315501,365638089060600,365730089063001,370000089122601,370333089135201,371745089302201,374532089404501,375410089511000,375419089505101,375715089541301,381247090212201,381248090165601,381434090214401,381744090223401,382107090212601,383053090154201,383123090155801,385224090123801,390239090435901,393318091073101,400642091252201,403749091173901,403851091142501,404753091054200,405256091012600,411023091022301,411130091032900,412532091003501,413026090363201,413102090340000,420450090112601,422840090381801,440605091432101,442342092023601,442912092174201,443334092205201,450438093164301,450438093164302&parameterCd=00060,00065,00010,00095,00480,00400,63680,99133', //&siteStatus=active
        function(error, response, body) {
            console.log(response.statusCode);
            if (!error && response.statusCode == 200) {
                var usgsData = JSON.parse(body);
                //console.log(body);
                getData(usgsData);
            }
        });



    function getData(d) {
        for (var i = 0; i < d.value.timeSeries.length; i++) {

            var lat = d.value.timeSeries[i].sourceInfo.geoLocation.geogLocation.latitude;

            var sid = d.value.timeSeries[i].sourceInfo.siteCode[0].value;

            var prop = d.value.timeSeries[i].variable.variableCode[0].value;
            if (prop == "00095") {
                prop = "cond";
            }
            if (prop == "00065") {
                prop = "height";
            }
            if (prop == "00400") {
                prop = "phval";
            }
            if (prop == "63680") {
                prop = "turb";
            }
            if (prop == "99133") {
                prop = "nit";
            }
            if (prop == "00480") {
                prop = "sal";
            }
            if (prop == "00010") {
                prop = "temp";
            }

            if (prop == "00060") {
                prop = "dis";
            }

            var value;

            // if (typeof d.value.timeSeries[i].values[0].value[0].value !== null) {
            //     console.log('the property is not available...'); // print into console
            // } // this doesn't work for some reason.

            try {
                value = d.value.timeSeries[i].values[0].value[0].value;
            } catch (err) {
                console.log("Error: " + err + ".");
            }

            console.log(i + " - sid: " + sid + " - lat: " + lat + " - prop: " + prop + " - value: " + value);

            if (value != -999999) {
                client.hset(prop, lat, value, redis.print);
            }

        }

    }



    // client.quit();
    callback();

}
